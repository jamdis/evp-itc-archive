<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archive Search (Minimal Demo)</title>
  <script src="https://unpkg.com/lunr/lunr.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    input[type="search"] { width: 100%; padding: .75rem 1rem; font-size: 1rem; }
    .result { padding: .75rem 0; border-bottom: 1px solid #ddd; }
    .meta { color:#666; font-size:.9rem; margin:.25rem 0; }
    .score { font-size:.8rem; color:#999; margin-left:.5rem; }
    .subject { font-weight:600; }
  </style>
</head>
<body>
  <h1>Search</h1>
  <input id="q" type="search" placeholder="type and hit Enter…" />
  <div id="status">Loading index…</div>
  <div id="results"></div>

 <script>
  let IDX = null;
  let DOCS = null;
  let BY_ID = null;

  // Load index + docs
  Promise.all([
    fetch("lunr_index.json").then(r => r.json()),
    fetch("docs.json").then(r => r.json())
  ]).then(([idxRaw, docs]) => {
    IDX = lunr.Index.load(idxRaw);
    DOCS = docs;
    BY_ID = Object.fromEntries(docs.map(d => [d.id, d]));
    document.getElementById('status').textContent =
      `Ready. ${docs.length} messages indexed.`;
    document.getElementById('q').focus();
  }).catch(err => {
    document.getElementById('status').textContent = "Failed to load index.";
    console.error(err);
  });

  // Run a search
  function search(query) {
    if (!IDX || !query.trim()) return [];
    return IDX.search(query).map(r => ({ ...BY_ID[r.ref], score: r.score }));
  }

  // Render results with clickable expansion to fetch full text
  async function showFullText(container, id) {
    container.textContent = "Loading…";
    try {
      const data = await fetch(`msg/${id}.json`).then(r => r.json());
      // simple escaping
      const text = (data.full_text || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      container.innerHTML = `<pre style="white-space:pre-wrap;margin:.5rem 0 0">${text}</pre>`;
    } catch (e) {
      container.textContent = "Failed to load message.";
    }
  }

  function render(items) {
    const box = document.getElementById('results');
    box.innerHTML = "";
    items.slice(0, 50).forEach(it => {
      const div = document.createElement('div');
      div.className = 'result';
      const previewId = `pv-${it.id}`;
      div.innerHTML = `
        <div class="subject">
          ${it.subject || "(no subject)"} <span class="score">score ${it.score.toFixed(3)}</span>
        </div>
        <div class="meta">${it.author || "unknown"} · ${it.timestamp || "no date"} · id ${it.id}</div>
        <button data-id="${it.id}" style="margin-top:.25rem">Show full text</button>
        <div id="${previewId}"></div>
      `;
      box.appendChild(div);
      const btn = div.querySelector("button");
      const tgt = div.querySelector(`#${previewId}`);
      btn.addEventListener("click", () => showFullText(tgt, it.id));
    });
    document.getElementById('status').textContent =
      `${items.length} result(s)`;
  }

  // Wire Enter key
  document.getElementById('q').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const q = e.currentTarget.value;
      render(search(q));
    }
  });
</script>
</body>
</html>
